{% extends "core/seshat-base.html" %}
{% load leaflet_tags %}

<head>
    {% leaflet_js %}
    {% leaflet_css %}
</head>

<body>
    {% block content %}
    <div style="display: flex;">
        <div>
            <fieldset>
                <legend>
                    <h3>Base Map</h3>
                </legend>
                <label><input type="radio" name="baseMap" value="carto" onclick="switchBaseMap()">No labels (CartoDB)</label><br>
                <label><input type="radio" name="baseMap" value="osm" onclick="switchBaseMap()"checked>OpenStreetMap</label><br>
            </fieldset>
            <p></p>
            <fieldset>
                <legend>
                    <h3>Show</h3>
                </legend>
                <label><input type="radio" name="displayedData" value="macro" onclick="selectDisplayedData()" checked>Historical polities</label><br>
                <label><input type="radio" name="displayedData" value="gadm" onclick="selectDisplayedData()">Current administrative areas</label><br>
            </fieldset>
            <p></p>
            <fieldset>
                <legend>
                    <h3>Show Polities</h3>
                </legend>
                <label><input type="radio" name="dateRange" value="single" checked onclick="toggleDateRange()">Specific year</label><br>
                <label><input type="radio" name="dateRange" value="range" onclick="toggleDateRange()">Date range</label><br><br>
            
                <!-- Display only when "dateRange" is set to "single" -->
                <div id="selectedYearContainer">
                    <div class="slidecontainer">
                        <input type="range" name="dateSlide" id="dateSlide" min="{{ earliest_century }}" max="{{ latest_century }}" value="0" class="slider" onchange="filterByYearRange()">
                        <button id="minusButton" type="button" onclick="adjustSliderDown()">-</button>
                        <button id="plusButton" type="button" onclick="adjustSliderUp()">+</button>
                        <span id="sliderDate"></span><br><br>
                        <label for="enterYear">Enter year:</label>
                        <input type="number" id="enterYear" name="enterYear" value="0"><br><br>
                        <label for="playButton">Run animation:</label>
                        <button id="playButton" type="button" onclick="startPlay()">▶️</button>
                        <button id="stopButton" type="button" onclick="stopPlay()">⏸</button><br>
                        <label for="playRate">Play rate (years per second):</label>
                        <input type="number" id="playRate" name="playRate" value="10"><br><br>
                    </div>
                </div>
            
                <!-- Display only when "dateRange" is set to "range" -->
                <div id="yearRangeContainer" style="display: none;">
                    <label for="startYear">From:</label>
                    <select name="startYear" id="startYear" onchange="filterByYearRange()">
                        {% for century, century_string in centuries.items %}
                            <option value="{{ century }}" {% if forloop.first %}selected{% endif %}>{{ century_string }}</option>
                        {% endfor %}
                    </select><br>
            
                    <label for="endYear">To:</label>
                    <select name="endYear" id="endYear" onchange="filterByYearRange()">
                        {% for century, century_string in centuries.items %}
                            <option value="{{ century }}" {% if forloop.last %}selected{% endif %}>{{ century_string }}</option>
                        {% endfor %}
                    </select><br>
                </div>
            </fieldset>
        </div>
        <div id="map" style="height: 75vh; flex: 1;"></div>
    </div>
    <script>

        var displayedShapes = [];

        var shapesData = [
            // JavaScript object representing shape data
            {% for shape in shapes %}
                {
                    startYear: '{{ shape.start_year }}',
                    endYear: '{{ shape.end_year }}',
                    geometry: '{{ shape.geom.geojson | safe }}',
                    name: '{{ shape.name }}',
                    colour: '{{ shape.colour }}'
                },
            {% endfor %}
        ];

        var map = L.map('map').setView([0, 0], 2);

        var baseLayers = {
            "carto": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'),
            "osm": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
        };

        // Select OSM as the default base layer
        var currentLayer = baseLayers.osm.addTo(map);

        function switchBaseMap() {
            var selectedMap = document.querySelector('input[name="baseMap"]:checked').value;
            map.removeLayer(currentLayer);
            currentLayer = baseLayers[selectedMap].addTo(map);
        }

        function filterByYearRange() {
            // Check if "Year" radio is selected
            var isSingleYear = document.querySelector('input[name="dateRange"][value="single"]').checked;

            if (isSingleYear) {
                var selectedYear = document.getElementById('dateSlide').value;

                // Remove all existing layers from the map
                map.eachLayer(function (layer) {
                    if (layer instanceof L.GeoJSON) {
                        map.removeLayer(layer);
                    }
                });

                // Convert to int, because for some reason JS converts it to a string
                var selectedYearInt = parseInt(selectedYear);

                // Add layers that are within the selected year to the map
                shapesData.forEach(function (shape) {
                    // If the shape spans the selected year
                    // Note: If the selected year is the shape.endYear it won't show. This decision prevents overlap in the macrostate dataset.
                    if ((parseInt(shape.startYear) <= selectedYearInt && parseInt(shape.endYear) > selectedYearInt)) {
                        var geoJSONLayer = L.geoJSON(JSON.parse(shape.geometry), {
                            style: function (feature) {
                                return {
                                    fillColor: shape.colour,  // Set the fill color based on the "colour" field
                                    color: shape.colour,  // Set the border color
                                    weight: 0,  // Set the border weight
                                    fillOpacity: 0.5  // Set the fill opacity
                                };
                            },
                            onEachFeature: function (feature, layer) {
                                var popupContent = '<b>Name:</b> ' + shape.name + '<br>' +
                                    '<b>Start Year:</b> ' + shape.startYear + '<br>' +
                                    '<b>End Year:</b> ' + shape.endYear;
                                layer.bindPopup(popupContent);
                            }
                        }).addTo(map);
                        // Update the displayedShapes array
                        if (displayedShapes.indexOf(shape.name) === -1) {
                            displayedShapes.push(shape.name);
                        }
                    }
                });
            } else {
                var startYear = document.getElementById('startYear').value;
                var endYear = document.getElementById('endYear').value;

                // Remove all existing layers from the map
                map.eachLayer(function (layer) {
                    if (layer instanceof L.GeoJSON) {
                        map.removeLayer(layer);
                    }
                });

                // Convert to ints, because for some reason JS converts them to strings
                var selectedStartYear = parseInt(startYear);
                var selectedEndYear = parseInt(endYear);

                // Add layers that are within the selected year range to the map
                shapesData.forEach(function (shape) {
                    // If the shape start date or end date falls in the selected range
                    if ((parseInt(shape.startYear) >= selectedStartYear && parseInt(shape.startYear) <= selectedEndYear) ||
                        (parseInt(shape.endYear) >= selectedStartYear && parseInt(shape.endYear) <= selectedEndYear)
                    ) {
                        var geoJSONLayer = L.geoJSON(JSON.parse(shape.geometry), {
                            style: function (feature) {
                                return {
                                    fillColor: shape.colour,  // Set the fill color based on the "colour" field
                                    color: shape.colour,  // Set the border color
                                    weight: 0,  // Set the border weight
                                    fillOpacity: 0.5  // Set the fill opacity
                                };
                            },
                            onEachFeature: function (feature, layer) {
                                var popupContent = '<b>Name:</b> ' + shape.name + '<br>' +
                                    '<b>Start Year:</b> ' + shape.startYear + '<br>' +
                                    '<b>End Year:</b> ' + shape.endYear;
                                layer.bindPopup(popupContent);
                            }
                        }).addTo(map);
                        // Update the displayedShapes array
                        if (displayedShapes.indexOf(shape.name) === -1) {
                            displayedShapes.push(shape.name);
                        }
                    }
                });
            }

            // Store the selected dateRange value in local storage
            var dateRange = document.querySelector('input[name="dateRange"]:checked').value;
            localStorage.setItem('dateRange', dateRange);
        }

        function selectDisplayedData() {
            var selectedData = document.querySelector('input[name="displayedData"]:checked').value;
            if (selectedData === 'gadm') {
                window.location.href = '{% url "gadm_map" %}';
            } else if (selectedData === 'macro') {
                window.location.href = '{% url "spatial_map" %}'
            } else {
                window.location.href = '{% url "spatial_map" %}?data=' + selectedData;
            }
        }

        // Function to toggle visibility of date range dropdowns
        function toggleDateRange() {
            var selectedValue = document.querySelector('input[name="dateRange"]:checked').value;
            var selectedYearContainer = document.getElementById('selectedYearContainer');
            var yearRangeContainer = document.getElementById('yearRangeContainer');

            if (selectedValue === 'single') {
                selectedYearContainer.style.display = 'block';
                yearRangeContainer.style.display = 'none';
            } else if (selectedValue === 'range') {
                selectedYearContainer.style.display = 'none';
                yearRangeContainer.style.display = 'block';
            }

            // Trigger filtering when the date range changes
            filterByYearRange();
        }

        // Initial filtering on page load
        filterByYearRange()

        // Display slider value
        var slider = document.getElementById("dateSlide");
        var enterYearInput = document.getElementById("enterYear");
        var output = document.getElementById("sliderDate");
        updateSliderOutput(); // Display the default slider value

        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function () {
            updateSliderOutput();
            // Sync enterYear input with dateSlide value
            enterYearInput.value = slider.value;
        }

        function updateSliderOutput() {
            if (slider.value < 0) {
                output.innerHTML = Math.abs(slider.value) + ' BCE';
            } else {
                output.innerHTML = slider.value + ' CE';
            }
        }

        function adjustSliderUp() {
            slider.value = Number(slider.value) + 1;
            enterYearInput.value = slider.value; // Sync enterYear input with dateSlide value
            updateSliderOutput(); // Update the displayed year
            filterByYearRange();
            // Update the color information in local storage for newly displayed shapes
            updateColorInfoInLocalStorage(displayedShapes);
        }

        function adjustSliderDown() {
            slider.value = Number(slider.value) - 1;
            enterYearInput.value = slider.value; // Sync enterYear input with dateSlide value
            updateSliderOutput(); // Update the displayed year
            filterByYearRange();
            // Update the color information in local storage for newly displayed shapes
            updateColorInfoInLocalStorage(displayedShapes);
        }

        function updateColorInfoInLocalStorage(updatedShapes) {
            var colorInfo = {};

            // Only update color information for the specified shapes
            shapesData.forEach(function (shape) {
                if (updatedShapes.indexOf(shape.name) !== -1) {
                    colorInfo[shape.name] = shape.colour;
                }
            });

            localStorage.setItem('colorInfo', JSON.stringify(colorInfo));
        }

        var playInterval;
        var playRateInput = document.getElementById("playRate");

        function startPlay() {
            stopPlay(); // Clear existing interval before starting a new one

            var yearsPerSecond = parseFloat(playRateInput.value);
            var milliseconds = 1 / (yearsPerSecond / 1000);

            playInterval = setInterval(function () {
                // Increment the slider value by 1
                slider.value = Number(slider.value) + 1;
                enterYearInput.value = slider.value; // Sync enterYear input with dateSlide value
                updateSliderOutput(); // Update the displayed year
                filterByYearRange();
                // Update the color information in local storage for newly displayed shapes
                updateColorInfoInLocalStorage(displayedShapes);

                // Stop playing when the slider reaches its maximum value
                if (slider.value >= parseInt(slider.max)) {
                    stopPlay();
                }
            }, milliseconds); // Interval based on user input
        }

        function stopPlay() {
            clearInterval(playInterval);
        }

        // Add event listener to stop playing when adjusting the slider manually
        slider.addEventListener("input", stopPlay);

        // Add event listener to update play rate when the input changes
        playRateInput.addEventListener("change", function () {
            stopPlay(); // Stop current play if ongoing
            startPlay(); // Start with the updated play rate
        });

        // Make sure Radio selection is kept on page refresh
        document.addEventListener("DOMContentLoaded", function () {
            // Get the country parameter from the URL
            var urlParams = new URLSearchParams(window.location.search);

            // Get the displayedData parameter from local storage
            var displayedData = localStorage.getItem('displayedData');
            if (displayedData) {
                // Set the selected radio button based on the stored value
                var radio = document.querySelector('input[name="displayedData"][value="' + displayedData + '"]');
                if (radio) {
                    radio.checked = true;
                }
            }

            // Get the dateRange parameter from local storage
            var dateRange = localStorage.getItem('dateRange');
            if (dateRange) {
                // Set the selected radio button based on the stored value
                var radio = document.querySelector('input[name="dateRange"][value="' + dateRange + '"]');
                if (radio) {
                    radio.checked = true;
                }

            }

            // Set default values for selectedYear, startYear, and endYear to 0CE
            var startYearSelect = document.getElementById('startYear');
            var endYearSelect = document.getElementById('endYear');
            startYearSelect.value = 0;
            endYearSelect.value = 0;

            // Retrieve color information from local storage
            var colorInfo = localStorage.getItem('colorInfo');
            if (colorInfo) {
                colorInfo = JSON.parse(colorInfo);
                shapesData.forEach(function (shape) {
                    var storedColor = colorInfo[shape.name];
                    if (storedColor) {
                        shape.colour = storedColor;
                    }
                });
            }

            // Trigger filtering when the page refreshes
            filterByYearRange();

        });

        // Store the selected displayedData and dateRange values in local storage
        document.addEventListener("change", function () {
            var displayedData = document.querySelector('input[name="displayedData"]:checked').value;
            localStorage.setItem('displayedData', displayedData);

            var dateRange = document.querySelector('input[name="dateRange"]:checked').value;
            localStorage.setItem('dateRange', dateRange);
        });

        // Update the enterYear input value when the user hits return
        enterYearInput.addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
                // Update the slider value
                slider.value = enterYearInput.value;
                updateSliderOutput();
                filterByYearRange();
                // Update the color information in local storage for newly displayed shapes
                updateColorInfoInLocalStorage(displayedShapes);
            }
        });

    </script>
    {% endblock %}
</body>