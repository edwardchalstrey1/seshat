{% extends "core/seshat-base.html" %}
{% load leaflet_tags %}

<head>
    {% leaflet_js %}
    {% leaflet_css %}
</head>

<body>
    {% block content %}
    <div style="display: flex;">
        <div>
            <fieldset>
                <legend>
                    <h3>Base Map</h3>
                </legend>
                <label><input type="radio" name="baseMap" value="carto" onclick="switchBaseMap()"checked>No labels (CartoDB)</label><br>
                <label><input type="radio" name="baseMap" value="osm" onclick="switchBaseMap()">OpenStreetMap</label><br>
            </fieldset>
            <p></p>
            <fieldset>
                <legend>
                    <h3>Show</h3>
                </legend>
                <label><input type="radio" name="displayedData" value="macro" onclick="selectDisplayedData()" checked>Historical polities</label><br>
                <label><input type="radio" name="displayedData" value="gadm" onclick="selectDisplayedData()">Current administrative areas</label><br>
            </fieldset>
            <p></p>
            <fieldset>
                <legend>
                    <h3>Show Polities</h3>
                </legend>
                <label><input type="radio" name="dateRange" value="single" checked>Year</label><br>
                <label><input type="radio" name="dateRange" value="range" >Year range</label><br>
                <label for="selectedYear">Selected year:</label>
                <select name="selectedYear" id="selectedYear" onchange="filterByYearRange()">
                    {% for century, century_string in centuries.items %}
                        <option value="{{ century }}" {% if forloop.first %}selected{% endif %}>{{ century_string }}</option>
                    {% endfor %}
                </select><br>
                <label for="startYear">From:</label>
                <select name="startYear" id="startYear" onchange="filterByYearRange()">
                    {% for century, century_string in centuries.items %}
                        <option value="{{ century }}" {% if forloop.first %}selected{% endif %}>{{ century_string }}</option>
                    {% endfor %}
                </select><br>
        
                <label for="endYear">To:</label>
                <select name="endYear" id="endYear" onchange="filterByYearRange()">
                    {% for century, century_string in centuries.items %}
                        <option value="{{ century }}" {% if forloop.last %}selected{% endif %}>{{ century_string }}</option>
                    {% endfor %}
                </select><br>
            </fieldset>
        </div>
        <div id="map" style="height: 75vh; flex: 1;"></div>
    </div>
    <div id="map" style="height: 75vh;"></div>
    {% leaflet_map "map" %}
    <script>

        var shapesData = [
            // JavaScript object representing shape data
            {% for shape in shapes %}
                {
                    startYear: '{{ shape.start_year }}',
                    endYear: '{{ shape.end_year }}',
                    geometry: '{{ shape.geom.geojson | safe }}',
                    name: '{{ shape.name }}'
                },
            {% endfor %}
        ];

        var map = L.map('map').setView([0, 0], 2);

        var baseLayers = {
            "carto": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'),
            "osm": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
        };

        var currentLayer = baseLayers.carto.addTo(map);

        function switchBaseMap() {
            var selectedMap = document.querySelector('input[name="baseMap"]:checked').value;
            map.removeLayer(currentLayer);
            currentLayer = baseLayers[selectedMap].addTo(map);
        }

        function filterByYearRange() {
            // Check if "Year" radio is selected
            var isSingleYear = document.querySelector('input[name="dateRange"][value="single"]').checked;

            if (isSingleYear) {
                var selectedYear = document.getElementById('selectedYear').value;

                // Remove all existing layers from the map
                map.eachLayer(function (layer) {
                    if (layer instanceof L.GeoJSON) {
                        map.removeLayer(layer);
                    }
                });

                // Convert to int, because for some reason JS converts it to a string
                var selectedYearInt = parseInt(selectedYear);

                // Add layers that are within the selected year to the map
                shapesData.forEach(function (shape) {
                    // If the shape spans the selected year
                    if (parseInt(shape.startYear) <= selectedYearInt && parseInt(shape.endYear) >= selectedYearInt) {
                        var geoJSONLayer = L.geoJSON(JSON.parse(shape.geometry), {
                            onEachFeature: function (feature, layer) {
                                var popupContent = '<b>Name:</b> ' + shape.name + '<br>' +
                                    '<b>Start Year:</b> ' + shape.startYear + '<br>' +
                                    '<b>End Year:</b> ' + shape.endYear;
                                layer.bindPopup(popupContent);
                            }
                        }).addTo(map);
                    }
                });
            } else {
                var startYear = document.getElementById('startYear').value;
                var endYear = document.getElementById('endYear').value;

                // Remove all existing layers from the map
                map.eachLayer(function (layer) {
                    if (layer instanceof L.GeoJSON) {
                        map.removeLayer(layer);
                    }
                });

                // Convert to ints, because for some reason JS converts them to strings
                var selectedStartYear = parseInt(startYear);
                var selectedEndYear = parseInt(endYear);

                // Add layers that are within the selected year range to the map
                shapesData.forEach(function (shape) {
                    // If the shape start date or end date falls in the selected range
                    if ((parseInt(shape.startYear) >= selectedStartYear && parseInt(shape.startYear) <= selectedEndYear) ||
                        (parseInt(shape.endYear) >= selectedStartYear && parseInt(shape.endYear) <= selectedEndYear)
                    ) {
                        var geoJSONLayer = L.geoJSON(JSON.parse(shape.geometry), {
                            onEachFeature: function (feature, layer) {
                                var popupContent = '<b>Name:</b> ' + shape.name + '<br>' +
                                    '<b>Start Year:</b> ' + shape.startYear + '<br>' +
                                    '<b>End Year:</b> ' + shape.endYear;
                                layer.bindPopup(popupContent);
                            }
                        }).addTo(map);
                    }
                });
            }
        }

        function selectDisplayedData() {
            var selectedData = document.querySelector('input[name="displayedData"]:checked').value;
            if (selectedData === 'gadm') {
                window.location.href = '{% url "gadm_map" %}';
            } else if (selectedData === 'macro') {
                window.location.href = '{% url "spatial_map" %}'
            } else {
                window.location.href = '{% url "spatial_map" %}?data=' + selectedData;
            }
        }

        // Initial filtering on page load
        filterByYearRange()

        // Make sure Radio selection is kept on page refresh
        document.addEventListener("DOMContentLoaded", function () {
            // Get the country parameter from the URL
            var urlParams = new URLSearchParams(window.location.search);

            // Get the displayedData parameter from local storage
            var displayedData = localStorage.getItem('displayedData');
            if (displayedData) {
                // Set the selected radio button based on the stored value
                var radio = document.querySelector('input[name="displayedData"][value="' + displayedData + '"]');
                if (radio) {
                    radio.checked = true;
                }
            }

            // Get the dateRange parameter from local storage
            var dateRange = localStorage.getItem('dateRange');
            if (dateRange) {
                // Set the selected radio button based on the stored value
                var radio = document.querySelector('input[name="dateRange"][value="' + dateRange + '"]');
                if (radio) {
                    radio.checked = true;
                }
            }
        });

        // Store the selected displayedData and dateRange values in local storage
        document.addEventListener("change", function () {
            var displayedData = document.querySelector('input[name="displayedData"]:checked').value;
            localStorage.setItem('displayedData', displayedData);

            var dateRange = document.querySelector('input[name="dateRange"]:checked').value;
            localStorage.setItem('dateRange', dateRange);
        });

    </script>
    {% endblock %}
</body>